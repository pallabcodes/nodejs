# ---------------------------------------------
# ğŸ“¦ .github/workflows/deploy.yml
# ---------------------------------------------

name: ğŸš€ Deploy to PM2 server

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repo
        uses: actions/checkout@v3

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” Lint (optional)
        run: npm run lint || echo "Linting skipped"

      - name: âš™ï¸ Build (if needed)
        run: echo "No build step configured"

      - name: ğŸ³ Docker Build
        run: docker build -t fp-middleware-api .

      - name: âœ… Run container (optional test run)
        run: |
          docker run -d -p 3000:3000 \
            -e NODE_ENV=production \
            -e JWT_SECRET=${{ secrets.JWT_SECRET }} \
            fp-middleware-api

      # Uncomment to deploy via SSH/PM2, Render, etc.
      # - name: ğŸš€ Deploy to Server
      #   uses: easingthemes/ssh-deploy@main
      #   with:
      #     ssh-private-key: ${{ secrets.SSH_KEY }}
      #     remote-user: ubuntu
      #     server-ip: ${{ secrets.SERVER_IP }}
      #     remote-path: /home/ubuntu/app
      #     local-path: .

      # - name: âœ… Restart via PM2
      #   run: ssh ubuntu@${{ secrets.SERVER_IP }} "pm2 restart ecosystem.config.js"

      - name: ğŸš€ Run PM2 Deployment Script
        run: bash ./scripts/deploy.sh

      - name: âœ… Done
        run: echo "âœ… Deployment pipeline complete."

# ğŸ“Œ Requirements:
# - Add JWT_SECRET (and optional SERVER_IP, SSH_KEY, etc.) to GitHub Secrets
# - Uncomment deploy blocks to enable deployment
